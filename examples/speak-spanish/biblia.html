<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Academic Spanish Trainer · Theology · Exegesis · Apologetics</title>
  <meta name="description" content="A single‑file, offline web app to help an American learner speak Academic Spanish about theology, biblical exegesis, and apologetics." />
  <style>
    :root{
      --bg: #0f172a;         /* slate-900 */
      --panel: #111827;      /* gray-900 */
      --muted: #94a3b8;      /* slate-400 */
      --text: #e5e7eb;       /* gray-200 */
      --accent: #22d3ee;     /* cyan-400 */
      --accent-2: #38bdf8;   /* sky-400 */
      --success: #34d399;    /* emerald-400 */
      --warn: #f59e0b;       /* amber-500 */
      --danger: #fb7185;     /* rose-400 */
      --card: #0b1220;       /* custom */
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius-xl: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 100% -10%, rgba(34,211,238,.12), transparent 60%),
                  radial-gradient(800px 600px at -10% 110%, rgba(56,189,248,.12), transparent 60%),
                  var(--bg);
      color: var(--text);
    }
    header{
      position: sticky; top:0; z-index:10; backdrop-filter: blur(8px);
      background: linear-gradient(to bottom, rgba(15,23,42,.85), rgba(15,23,42,.65));
      border-bottom: 1px solid rgba(148,163,184,.15);
    }
    .container{max-width:1180px; margin:0 auto; padding: 14px 18px}
    .brand{display:flex; align-items:center; gap:12px}
    .logo{width:38px; height:38px; border-radius:10px; background:
      radial-gradient(10px 10px at 30% 30%, rgba(34,211,238,.95), transparent 70%),
      radial-gradient(16px 18px at 70% 70%, rgba(56,189,248,.8), transparent 70%),
      linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%); box-shadow: var(--shadow)}
    h1{font-size: clamp(16px, 2.4vw, 22px); margin:0; letter-spacing:.3px}
    .subtitle{font-size:13px; color: var(--muted)}

    .toolbar{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .toolbar > *{margin-left:auto}

    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
      border:1px solid rgba(148,163,184,.22); color: var(--text); background: #0b1220; cursor:pointer;
    }
    .pill input{accent-color: var(--accent);}

    nav{position: sticky; top:72px; z-index:8; background: linear-gradient(to bottom, rgba(17,24,39,.9), rgba(17,24,39,.7)); border-bottom:1px solid rgba(148,163,184,.12)}
    .tabs{display:grid; grid-auto-flow:column; grid-auto-columns: minmax(130px, 1fr); gap:8px; padding: 10px 18px; max-width:1180px; margin:0 auto}
    .tab{padding:10px 14px; text-align:center; border-radius:14px; border:1px solid rgba(148,163,184,.18); cursor:pointer; user-select:none; transition: transform .08s ease}
    .tab:hover{transform: translateY(-1px)}
    .tab.active{background: linear-gradient(180deg, rgba(34,211,238,.12), rgba(56,189,248,.08)); border-color: rgba(34,211,238,.35)}

    main{max-width:1180px; margin: 16px auto; padding: 0 18px 60px}
    section[role="tabpanel"]{display:none}
    section[role="tabpanel"].active{display:block}

    .grid{display:grid; gap:16px}
    .grid.cols-2{grid-template-columns: repeat(2, minmax(0,1fr))}
    .grid.cols-3{grid-template-columns: repeat(3, minmax(0,1fr))}
    @media (max-width: 980px){.grid.cols-3{grid-template-columns:1fr}.grid.cols-2{grid-template-columns:1fr}}

    .card{background: linear-gradient(180deg, rgba(148,163,184,.06), rgba(148,163,184,.03));
      border:1px solid rgba(148,163,184,.15); border-radius: var(--radius-xl); box-shadow: var(--shadow); padding:16px}
    .card h3{margin:6px 0 10px; font-size:18px}
    .card .muted{color: var(--muted); font-size:13px}

    .btn{padding:10px 14px; border-radius:12px; background: linear-gradient(180deg, rgba(34,211,238,.18), rgba(56,189,248,.12));
      border:1px solid rgba(34,211,238,.45); color:#dff8ff; cursor:pointer; user-select:none}
    .btn.secondary{background: transparent; border-color: rgba(148,163,184,.22); color: var(--text)}
    .btn.ghost{background: transparent; border-color: transparent; color: var(--muted)}
    .btn:disabled{opacity:.5; cursor:not-allowed}

    .stack{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
    .row{display:flex; gap:10px; align-items:center}
    .col{display:flex; flex-direction:column; gap:10px}

    input[type="text"], textarea, select{
      width:100%; background: #0b1220; color: var(--text); border:1px solid rgba(148,163,184,.22);
      border-radius:12px; padding:10px 12px; outline: none
    }
    textarea{min-height:120px; resize:vertical}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#0b1220; border:1px solid rgba(148,163,184,.25); border-radius:8px; padding:2px 6px; font-size:12px}

    .tag{display:inline-block; padding:4px 8px; font-size:12px; border-radius:999px; border:1px solid rgba(148,163,184,.22); color: var(--muted)}

    .list{display:grid; gap:10px}
    .list .item{padding:12px; border-radius:12px; background:#0b1220; border:1px solid rgba(148,163,184,.15)}

    .callout{padding:12px; border-left:4px solid var(--accent-2); background: #0b1220; border-radius:12px}
    .score{font-weight:700}
    .hidden{display:none}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <header>
    <div class="container" role="banner" aria-label="App header">
      <div class="row" style="justify-content: space-between; align-items: center; gap:14px">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>Academic Spanish Trainer</h1>
            <div class="subtitle">Teología · Exégesis Bíblica · Apologética — offline, single‑file</div>
          </div>
        </div>
        <div class="toolbar">
          <label class="pill" title="Spanish‑only interface (oculta traducciones)"><input type="checkbox" id="spanishOnly"> <span>Modo inmersivo</span></label>
          <label class="pill" title="Enable microphone for pronunciation practice"><input type="checkbox" id="micToggle"> <span>Micrófono</span></label>
          <button class="pill" id="voiceBtn" title="Choose a Spanish voice">Voz: <span id="voiceName">auto</span></button>
          <label class="pill" title="Speech speed"><span>Velocidad</span>
            <input type="range" min="0.8" max="1.35" step="0.05" value="1" id="rateRange" style="width:140px">
          </label>
        </div>
      </div>
    </div>
  </header>

  <nav aria-label="Primary">
    <div class="tabs" role="tablist" id="tabs">
      <div class="tab active" data-tab="dashboard" role="tab" tabindex="0">Dashboard</div>
      <div class="tab" data-tab="flashcards" role="tab" tabindex="0">Flashcards</div>
      <div class="tab" data-tab="drills" role="tab" tabindex="0">Listening & Speaking</div>
      <div class="tab" data-tab="argument" role="tab" tabindex="0">Argument Builder</div>
      <div class="tab" data-tab="reading" role="tab" tabindex="0">Reading Lab</div>
      <div class="tab" data-tab="debate" role="tab" tabindex="0">Debate Simulator</div>
      <div class="tab" data-tab="quiz" role="tab" tabindex="0">Quiz</div>
      <div class="tab" data-tab="resources" role="tab" tabindex="0">Resources</div>
      <div class="tab" data-tab="settings" role="tab" tabindex="0">Settings</div>
    </div>
  </nav>

  <main>
    <!-- DASHBOARD -->
    <section id="dashboard" role="tabpanel" class="active">
      <div class="grid cols-3">
        <div class="card">
          <h3>Start here</h3>
          <p class="muted">Pick a module below. This trainer focuses on academic Spanish required for theology, biblical exegesis, and apologetics debates. Everything works offline and saves to your browser.</p>
          <div class="stack">
            <button class="btn" data-goto="flashcards">Vocabulary</button>
            <button class="btn" data-goto="drills">Listening</button>
            <button class="btn" data-goto="argument">Compose</button>
            <button class="btn" data-goto="reading">Read</button>
            <button class="btn" data-goto="debate">Debate</button>
            <button class="btn" data-goto="quiz">Quiz</button>
          </div>
          <div class="callout" style="margin-top:12px">
            <strong>Tip:</strong> Toggle <em>Modo inmersivo</em> to hide English and force Spanish‑only.
          </div>
        </div>

        <div class="card">
          <h3>Daily Plan (auto)</h3>
          <div id="dailyPlan" class="list"></div>
          <div class="row">
            <button class="btn" id="regenPlan">Regenerate</button>
            <button class="btn secondary" id="markDone">Mark done</button>
          </div>
        </div>

        <div class="card">
          <h3>Progress</h3>
          <div class="list">
            <div class="item">Known terms: <span id="knownCount">0</span></div>
            <div class="item">Drill streak: <span id="streak">0</span> days</div>
            <div class="item">Debate prompts attempted: <span id="debateCount">0</span></div>
          </div>
          <div class="row" style="margin-top:8px">
            <button class="btn secondary" id="exportBtn">Export progress</button>
            <input type="file" id="importFile" accept="application/json" class="hidden" />
            <button class="btn secondary" id="importBtn">Import</button>
          </div>
        </div>
      </div>
    </section>

    <!-- FLASHCARDS -->
    <section id="flashcards" role="tabpanel">
      <div class="grid cols-2">
        <div class="card">
          <h3>Core Academic Vocabulary</h3>
          <p class="muted">Swipe through key terms used in seminar‑level discussions. Use <span class="kbd">Space</span> to flip, <span class="kbd">→</span>/<span class="kbd">←</span> to navigate.</p>
          <div class="item" id="flashcard" style="min-height:160px; display:flex; align-items:center; justify-content:center; font-size:22px; border-radius:14px"></div>
          <div class="row">
            <button class="btn secondary" id="prevCard">← Prev</button>
            <button class="btn" id="flipCard">Flip</button>
            <button class="btn secondary" id="nextCard">Next →</button>
            <button class="btn right" id="markKnown">Mark known ✓</button>
          </div>
          <div class="row" style="margin-top:6px">
            <label class="pill"><input type="checkbox" id="filterTheo" checked> Theology</label>
            <label class="pill"><input type="checkbox" id="filterExeg" checked> Exegesis</label>
            <label class="pill"><input type="checkbox" id="filterApolo" checked> Apologetics</label>
          </div>
        </div>

        <div class="card">
          <h3>Custom Pack</h3>
          <p class="muted">Add your own high‑priority terms.</p>
          <div class="grid">
            <input type="text" id="customEs" placeholder="Término en español (p. ej., ‘expiación sustitutiva’)" />
            <input type="text" id="customEn" placeholder="English gloss (e.g., ‘substitutionary atonement’)" />
            <select id="customDomain">
              <option value="theology">Theology</option>
              <option value="exegesis">Exegesis</option>
              <option value="apologetics">Apologetics</option>
            </select>
            <button class="btn" id="addCustom">Add</button>
          </div>
          <div class="list" id="customList"></div>
        </div>
      </div>
    </section>

    <!-- DRILLS -->
    <section id="drills" role="tabpanel">
      <div class="grid cols-2">
        <div class="card">
          <h3>Listen → Shadow → Record</h3>
          <p class="muted">Play an academic sentence, shadow it, then record and get a similarity score (approximate).</p>
          <div class="stack" style="margin-bottom:8px">
            <select id="drillSelect"></select>
            <div class="row">
              <button class="btn" id="playDrill">▶ Play</button>
              <button class="btn secondary" id="recordBtn" disabled>● Record</button>
              <button class="btn secondary" id="stopBtn" disabled>■ Stop</button>
            </div>
          </div>
          <div class="item" id="drillSentence" style="min-height:88px"></div>
          <div class="callout" id="drillFeedback">Ready.</div>
        </div>
        <div class="card">
          <h3>Pronunciation Practice (free speak)</h3>
          <p class="muted">Speak freely in Spanish; your transcript will appear below. Use it to self‑critique register and grammar.</p>
          <div class="row">
            <button class="btn" id="startFree">Start</button>
            <button class="btn secondary" id="stopFree" disabled>Stop</button>
          </div>
          <textarea id="freeTranscript" placeholder="Transcripción en tiempo real…"></textarea>
          <div class="muted">Note: Browser speech recognition varies by platform. Best in Chromium‑based browsers.</div>
        </div>
      </div>
    </section>

    <!-- ARGUMENT BUILDER -->
    <section id="argument" role="tabpanel">
      <div class="grid cols-2">
        <div class="card">
          <h3>Compose a Scholarly Paragraph</h3>
          <p class="muted">Use formal connectors and academic frames. Then hear it out loud.</p>
          <div class="grid">
            <select id="argTopic"></select>
            <select id="argRegister">
              <option value="formal">Registro académico (formal)</option>
              <option value="pastoral">Registro pastoral (cálido)</option>
            </select>
            <textarea id="argPoints" placeholder="Premisas o ideas clave (una por línea)"></textarea>
            <div class="row">
              <button class="btn" id="buildArg">Build</button>
              <button class="btn secondary" id="speakArg" disabled>Speak</button>
              <button class="btn secondary" id="copyArg" disabled>Copy</button>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>Output</h3>
          <div id="argOutput" class="item" style="min-height:180px"></div>
          <div class="muted">Tip: Switch register to adjust warmth vs. rigor.</div>
        </div>
      </div>
    </section>

    <!-- READING LAB -->
    <section id="reading" role="tabpanel">
      <div class="grid cols-2">
        <div class="card">
          <h3>Scholarly Passage</h3>
          <p class="muted">Hover for glosses. Toggle Spanish‑only to hide English.</p>
          <div id="readingText" class="item" style="line-height:1.65"></div>
          <div class="stack">
            <button class="btn" id="speakReading">▶ Read aloud</button>
            <button class="btn secondary" id="nextReading">Next passage</button>
          </div>
        </div>
        <div class="card">
          <h3>Comprehension</h3>
          <div class="list" id="readingQs"></div>
          <div class="row" style="margin-top:8px">
            <button class="btn" id="checkReading">Check</button>
            <div id="readingScore" class="right score"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- DEBATE SIMULATOR -->
    <section id="debate" role="tabpanel">
      <div class="grid cols-2">
        <div class="card">
          <h3>Choose a Prompt</h3>
          <p class="muted">Practice respectful, rigorous apologetics in Spanish.</p>
          <div class="grid">
            <select id="debatePrompt"></select>
            <select id="debateStance">
              <option value="affirmativa">Postura afirmativa</option>
              <option value="negativa">Postura negativa</option>
            </select>
            <button class="btn" id="startDebate">Start round</button>
          </div>
          <div class="item" id="debateCue" style="min-height:100px"></div>
          <div class="row">
            <button class="btn secondary" id="debateSpeak" disabled>Speak cue</button>
            <button class="btn secondary" id="debateCopy" disabled>Copy cue</button>
          </div>
        </div>
        <div class="card">
          <h3>Response Workspace</h3>
          <textarea id="debateResponse" placeholder="Redacte su respuesta en español…"></textarea>
          <div class="row">
            <button class="btn" id="debateEvaluate">Evaluate</button>
            <div id="debateFeedback" class="right"></div>
          </div>
          <div class="muted">Heuristics only: checks connectors, hedging, thesis clarity, cohesion markers.</div>
        </div>
      </div>
    </section>

    <!-- QUIZ -->
    <section id="quiz" role="tabpanel">
      <div class="grid cols-2">
        <div class="card">
          <h3>Terminology · Cloze</h3>
          <div id="clozeWrap" class="list"></div>
          <div class="row" style="margin-top:8px">
            <button class="btn" id="regenCloze">Regenerate</button>
            <button class="btn secondary" id="checkCloze">Check</button>
            <div class="right score" id="clozeScore"></div>
          </div>
        </div>
        <div class="card">
          <h3>Multiple Choice</h3>
          <div id="mcWrap" class="list"></div>
          <div class="row" style="margin-top:8px">
            <button class="btn" id="regenMC">Regenerate</button>
            <button class="btn secondary" id="checkMC">Check</button>
            <div class="right score" id="mcScore"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- RESOURCES -->
    <section id="resources" role="tabpanel">
      <div class="grid cols-3">
        <div class="card">
          <h3>Connectors (Registro académico)</h3>
          <div class="list" id="connectorList"></div>
        </div>
        <div class="card">
          <h3>Exegesis Workflow (ES)</h3>
          <ol id="exegesisSteps" style="padding-left:18px"></ol>
          <div class="muted">Use these steps to narrate your method aloud in Spanish.</div>
        </div>
        <div class="card">
          <h3>Accent & Subjunctive Cheats</h3>
          <div class="list">
            <div class="item"><strong>Stress:</strong> palabras que terminan en vocal, <em>n</em> o <em>s</em> llevan el acento en la penúltima sílaba; si no, en la última (salvo tilde).</div>
            <div class="item"><strong>Subjunctive triggers:</strong> dudar que, es posible que, no creo que, es necesario que, para que, a fin de que, sin que.</div>
            <div class="item"><strong>Academic hedging:</strong> parece indicar que, sugiere que, podría interpretarse como, cabe señalar que.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="settings" role="tabpanel">
      <div class="grid cols-2">
        <div class="card">
          <h3>Voice & Speech</h3>
          <div class="list">
            <div class="item">Selected voice: <span id="voiceInfo">(auto)</span></div>
            <div class="item">Rate: <span id="rateInfo">1.00</span></div>
            <div class="item">Recognition: <span id="recogInfo">n/a</span></div>
          </div>
        </div>
        <div class="card">
          <h3>Data</h3>
          <div class="row">
            <button class="btn" id="resetBtn">Reset progress</button>
            <div class="muted">This clears known terms, streak, and custom items.</div>
          </div>
        </div>
      </div>
    </section>
    <footer class="wrap muted small" style="padding-bottom:40px">
      <div class="small">Powered by GPT-5</div>
    </footer>
  </main>
  <script>
  /****************************
   * Data: curated core terms *
   ****************************/
  const CORE_TERMS = [
    {es:"exégesis", en:"exegesis", domain:"exegesis"},
    {es:"hermenéutica", en:"hermeneutics", domain:"exegesis"},
    {es:"crítica textual", en:"textual criticism", domain:"exegesis"},
    {es:"canonicidad", en:"canonicity", domain:"exegesis"},
    {es:"contexto literario", en:"literary context", domain:"exegesis"},
    {es:"intertextualidad", en:"intertextuality", domain:"exegesis"},
    {es:"pacto abrahámico", en:"Abrahamic covenant", domain:"theology"},
    {es:"pacto davídico", en:"Davidic covenant", domain:"theology"},
    {es:"Nueva Alianza", en:"New Covenant", domain:"theology"},
    {es:"soteriología", en:"soteriology", domain:"theology"},
    {es:"justificación por la fe", en:"justification by faith", domain:"theology"},
    {es:"santificación", en:"sanctification", domain:"theology"},
    {es:"expiación sustitutiva", en:"substitutionary atonement", domain:"theology"},
    {es:"trinidad consubstancial", en:"consubstantial Trinity", domain:"theology"},
    {es:"encarnación", en:"incarnation", domain:"theology"},
    {es:"resurrección corporal", en:"bodily resurrection", domain:"theology"},
    {es:"argumento cosmológico", en:"cosmological argument", domain:"apologetics"},
    {es:"argumento teleológico", en:"teleological argument", domain:"apologetics"},
    {es:"argumento moral", en:"moral argument", domain:"apologetics"},
    {es:"argumento ontológico", en:"ontological argument", domain:"apologetics"},
    {es:"problema del mal", en:"problem of evil", domain:"apologetics"},
    {es:"fiabilidad del Nuevo Testamento", en:"NT reliability", domain:"apologetics"},
    {es:"transmisión manuscrita", en:"manuscript transmission", domain:"apologetics"},
    {es:"testimonio histórico", en:"historical testimony", domain:"apologetics"},
    {es:"razón suficiente", en:"sufficient reason", domain:"apologetics"},
    {es:"metanarrativa bíblica", en:"biblical metanarrative", domain:"theology"},
  ];

  const DRILLS = [
    "Desde una perspectiva exegética, el contexto inmediato ilumina el sentido del pasaje.",
    "El autor emplea una estructura quiástica que organiza el argumento teológico.",
    "Según la crítica textual, la variante más difícil suele ser la lectura original.",
    "La doctrina de la justificación por la fe se fundamenta en la obra consumada de Cristo.",
    "El problema del mal exige una respuesta teodicea que no trivialice el sufrimiento humano.",
    "La resurrección corporal de Jesús constituye el eje de la fe apostólica.",
  ];

  const ARG_TOPICS = [
    {id:"resurrection", label:"Resurrección de Jesús"},
    {id:"trinity", label:"Doctrina de la Trinidad"},
    {id:"scripture", label:"Fiabilidad de la Escritura"},
    {id:"evil", label:"Problema del mal"},
    {id:"atonement", label:"Expiación sustitutiva"},
  ];

  const READING_PASSAGES = [
    {
      text: "La exégesis responsable atiende al género literario, al trasfondo histórico y a la intertextualidad. Al situar un texto dentro del canon, se evita una lectura atomista que desfigure su función teológica.",
      q: [
        {p:"Mencione dos factores que exige la exégesis responsable.", a:["género literario","trasfondo histórico","intertextualidad"]},
        {p:"¿Qué lectura se evita al situar un texto dentro del canon?", a:["atomista"]}
      ]
    },
    {
      text: "\"En el principio era el Verbo, y el Verbo era con Dios, y el Verbo era Dios\" (Juan 1:1, Reina‑Valera Antigua). Este prólogo articula una cristología alta que vincula creación y revelación.",
      q: [
        {p:"¿Qué relación vincula el prólogo de Juan según el texto?", a:["creación","revelación"]},
        {p:"¿Qué tipo de cristología articula?", a:["alta"]}
      ]
    },
    {
      text: "En apologética académica, el uso de marcadores discursivos —como ‘por consiguiente’, ‘no obstante’ y ‘en definitiva’— incrementa la cohesión y la persuasión sin caer en estridencias retóricas.",
      q: [
        {p:"Mencione dos marcadores discursivos del texto.", a:["por consiguiente","no obstante","en definitiva"]},
        {p:"¿Qué incrementan dichos marcadores?", a:["cohesión","persuasión"]}
      ]
    }
  ];

  const DEBATE_PROMPTS = [
    {id:"evil", title:"¿El problema del mal es incompatible con un Dios omnipotente y bueno?"},
    {id:"reliability", title:"¿Es históricamente fiable el testimonio de la resurrección?"},
    {id:"theism", title:"¿Ofrece el teísmo una mejor explicación de la moral objetiva que el naturalismo?"},
    {id:"trinity", title:"¿Es bíblica la doctrina de la Trinidad?"}
  ];

  const CONNECTORS = [
    {es:"según el texto", en:"according to the text"},
    {es:"desde una perspectiva exegética", en:"from an exegetical perspective"},
    {es:"a nivel teológico", en:"at a theological level"},
    {es:"por consiguiente", en:"therefore"},
    {es:"no obstante", en:"nevertheless"},
    {es:"en definitiva", en:"ultimately"},
    {es:"cabe señalar que", en:"it should be noted that"},
    {es:"a la luz de", en:"in light of"},
    {es:"a fin de", en:"in order to"},
    {es:"por medio de", en:"by means of"},
    {es:"en contraste con", en:"in contrast with"},
    {es:"en términos hermenéuticos", en:"in hermeneutical terms"},
  ];

  const EXEGESIS_STEPS = [
    "Observación: léxico clave, repetición, estructura, marcadores.",
    "Contexto: histórico, canónico, literario (género, macroestructura).",
    "Crítica textual: variantes, lecturas difíciles, evidencia externa/interna.",
    "Interpretación: flujo argumental, teología del autor, intertextos.",
    "Correlación: unidad bíblica, conexiones canónicas, tipología responsable.",
    "Aplicación: implicaciones doctrinales y pastorales, prudencia retórica."
  ];

  // Simple MC bank derived from CORE_TERMS
  const MC_BANK = [
    {q:"‘hermenéutica’ se refiere a…", options:["la teoría de la interpretación","un tipo de poesía","una figura retórica"], a:0},
    {q:"‘expiación sustitutiva’ significa…", options:["una lectura alegórica","Cristo muere en lugar del pecador","una crítica literaria"], a:1},
    {q:"‘problema del mal’ designa…", options:["una objeción a la existencia de Dios","un libro de proverbios","una oración doxológica"], a:0},
  ];

  /***********************
   * Persistence helpers *
   ***********************/
  const mem = {
    get(k, def){
      try{ return JSON.parse(localStorage.getItem(k)) ?? def }catch{ return def }
    },
    set(k, v){ localStorage.setItem(k, JSON.stringify(v)) }
  };

  const state = {
    known: mem.get('known', {}),
    custom: mem.get('custom', []),
    streak: mem.get('streak', 0),
    lastDay: mem.get('lastDay', null),
    debateCount: mem.get('debateCount', 0),
  };

  function todayKey(){
    const d = new Date(); return d.toISOString().slice(0,10);
  }

  function updateStreak(){
    const today = todayKey();
    if(state.lastDay !== today){
      // if yesterday, +1; else reset to 1
      const y = new Date(); y.setDate(y.getDate()-1);
      const yk = y.toISOString().slice(0,10);
      state.streak = (state.lastDay === yk) ? (state.streak+1) : 1;
      state.lastDay = today;
      mem.set('streak', state.streak);
      mem.set('lastDay', state.lastDay);
    }
  }

  /****************
   * UI wiring    *
   ****************/
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  // Tabs
  $$('#tabs .tab').forEach(t=>{
    t.addEventListener('click', ()=> gotoTab(t.dataset.tab));
    t.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); gotoTab(t.dataset.tab) } });
  });

  function gotoTab(id){
    $$('#tabs .tab').forEach(t=> t.classList.toggle('active', t.dataset.tab===id));
    $$('section[role="tabpanel"]').forEach(s=> s.classList.toggle('active', s.id===id));
  }

  // Cross‑nav buttons
  $$('[data-goto]').forEach(b=> b.addEventListener('click', ()=> gotoTab(b.dataset.goto)));

  // Spanish‑only toggle
  const spanishOnly = $('#spanishOnly');
  spanishOnly.addEventListener('change', renderAll);

  // Voice selection
  const voiceBtn = $('#voiceBtn');
  const voiceName = $('#voiceName');
  const rateRange = $('#rateRange');
  const rateInfo = $('#rateInfo');
  let voice = null;
  function populateVoice(){
    const voices = window.speechSynthesis?.getVoices?.() || [];
    const es = voices.filter(v=> /es|Spanish/i.test(v.lang));
    voice = es[0] || voices.find(v=>/es|Spanish/i.test(v.name)) || null;
    voiceName.textContent = voice? `${voice.name}` : 'auto';
    $('#voiceInfo').textContent = voice? `${voice.name} · ${voice.lang}`: '(auto)';
  }
  if('speechSynthesis' in window){
    speechSynthesis.onvoiceschanged = populateVoice; populateVoice();
  }

  function speak(text, lang='es-ES'){
    if(!('speechSynthesis' in window)) return;
    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang; u.rate = parseFloat(rateRange.value||'1');
    if(voice) u.voice = voice;
    speechSynthesis.speak(u);
  }

  voiceBtn.addEventListener('click', ()=>{
    // cycle through Spanish voices if available
    const voices = window.speechSynthesis?.getVoices?.() || [];
    const es = voices.filter(v=> /es|Spanish/i.test(v.lang));
    if(!es.length){ alert('No Spanish voices detected. Your system/browser may still synthesize Spanish using a default voice.'); return }
    const idx = es.indexOf(voice);
    voice = es[(idx+1)%es.length];
    voiceName.textContent = voice.name; $('#voiceInfo').textContent = `${voice.name} · ${voice.lang}`;
  });

  rateRange.addEventListener('input', ()=> rateInfo.textContent = parseFloat(rateRange.value).toFixed(2));

  // Recognition (webkitSpeechRecognition)
  let rec = null; let recording = false; let freeRec = null; let freeOn = false;
  function setupRecognition(){
    const R = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!R){ $('#recogInfo').textContent = 'not supported'; return }
    rec = new R(); rec.lang='es-ES'; rec.interimResults=true; rec.continuous=true;
    $('#recogInfo').textContent = 'available';
  }
  setupRecognition();

  // Mic toggle
  const micToggle = $('#micToggle');
  micToggle.addEventListener('change', ()=>{
    const on = micToggle.checked;
    $('#recordBtn').disabled = !on;
    if(!on && recording){ try{ rec.stop() }catch{} recording=false }
    if(!on && freeOn){ try{ freeRec.stop() }catch{} freeOn=false }
  });

  /****************
   * Dashboard    *
   ****************/
  function genPlan(){
    const plan = [
      'Flashcards: 10 términos (5 min)',
      'Listening: 3 oraciones académicas (5 min)',
      'Compose: 1 párrafo sobre un tema (10 min)',
      'Reading: 1 pasaje + preguntas (10 min)',
      'Debate: 1 postura breve (5 min)'
    ];
    const cont = $('#dailyPlan'); cont.innerHTML='';
    plan.forEach(t=>{ const div=document.createElement('div'); div.className='item'; div.textContent=t; cont.appendChild(div) });
  }
  $('#regenPlan').addEventListener('click', genPlan);
  $('#markDone').addEventListener('click', ()=>{ updateStreak(); renderProgress() });

  function renderProgress(){
    $('#knownCount').textContent = Object.keys(state.known).length;
    $('#streak').textContent = state.streak;
    $('#debateCount').textContent = state.debateCount;
  }

  // Export/Import
  $('#exportBtn').addEventListener('click', ()=>{
    const data = {state};
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='academic-spanish-progress.json'; a.click(); URL.revokeObjectURL(url);
  });
  $('#importBtn').addEventListener('click', ()=> $('#importFile').click());
  $('#importFile').addEventListener('change', (e)=>{
    const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{
      try{ const obj=JSON.parse(r.result); if(obj.state){ Object.assign(state, obj.state); mem.set('known', state.known); mem.set('custom', state.custom); mem.set('streak', state.streak); mem.set('lastDay', state.lastDay); mem.set('debateCount', state.debateCount); renderAll() } }
      catch(err){ alert('Invalid file.') }
    }; r.readAsText(f);
  });

  /****************
   * Flashcards   *
   ****************/
  let deck = []; let idx = 0; let flipped=false;

  function computeDeck(){
    const filters = {
      theology: $('#filterTheo').checked,
      exegesis: $('#filterExeg').checked,
      apologetics: $('#filterApolo').checked,
    };
    deck = [...CORE_TERMS, ...state.custom].filter(t=> filters[t.domain]);
    if(deck.length===0) deck=[{es:'(sin términos)', en:'(no terms)', domain:'theology'}];
    idx=0; flipped=false; renderCard();
  }

  function renderCard(){
    const t = deck[idx]; const box = $('#flashcard');
    box.innerHTML = `<div style="text-align:center">
      <div style="font-size:14px; color:var(--muted); margin-bottom:6px">${idx+1} / ${deck.length} · <span class="tag">${t.domain}</span></div>
      <div style="font-weight:700">${spanishOnly.checked? t.es : (flipped? t.en+'<br><span style=\"color:var(--muted); font-weight:400\">'+t.es+'</span>' : t.es)}</div>
    </div>`;
  }

  $('#flipCard').addEventListener('click', ()=>{ flipped=!flipped; renderCard() });
  $('#nextCard').addEventListener('click', ()=>{ idx=(idx+1)%deck.length; flipped=false; renderCard() });
  $('#prevCard').addEventListener('click', ()=>{ idx=(idx-1+deck.length)%deck.length; flipped=false; renderCard() });
  $('#markKnown').addEventListener('click', ()=>{ const key = deck[idx].es; state.known[key]=true; mem.set('known', state.known); renderProgress() });
  ['filterTheo','filterExeg','filterApolo'].forEach(id=> $('#'+id).addEventListener('change', computeDeck));

  // keyboard
  document.addEventListener('keydown', (e)=>{
    if(document.activeElement.tagName==='TEXTAREA' || document.activeElement.tagName==='INPUT') return;
    if(e.key===' ') { e.preventDefault(); const tab=$$('.tab.active')[0]; if(tab?.dataset.tab==='flashcards'){ flipped=!flipped; renderCard() } }
    if(e.key==='ArrowRight'){ const tab=$$('.tab.active')[0]; if(tab?.dataset.tab==='flashcards'){ idx=(idx+1)%deck.length; flipped=false; renderCard() } }
    if(e.key==='ArrowLeft'){ const tab=$$('.tab.active')[0]; if(tab?.dataset.tab==='flashcards'){ idx=(idx-1+deck.length)%deck.length; flipped=false; renderCard() } }
  });

  // Custom pack
  $('#addCustom').addEventListener('click', ()=>{
    const es=$('#customEs').value.trim(); const en=$('#customEn').value.trim(); const domain=$('#customDomain').value;
    if(!es||!en){ alert('Provide Spanish and English.'); return }
    state.custom.push({es,en,domain}); mem.set('custom', state.custom); $('#customEs').value=''; $('#customEn').value=''; renderCustom(); computeDeck();
  });

  function renderCustom(){
    const list=$('#customList'); list.innerHTML='';
    state.custom.forEach((t,i)=>{
      const div=document.createElement('div'); div.className='item';
      div.innerHTML = `<div class="row" style="justify-content:space-between"><div><strong>${t.es}</strong> — <span class="muted">${spanishOnly.checked? '' : t.en}</span> <span class="tag">${t.domain}</span></div><button class="btn ghost" aria-label="Delete" data-i="${i}">Delete</button></div>`;
      list.appendChild(div);
    });
    list.querySelectorAll('button[data-i]').forEach(b=> b.addEventListener('click', ()=>{ const i=parseInt(b.dataset.i); state.custom.splice(i,1); mem.set('custom', state.custom); renderCustom(); computeDeck() }));
  }

  /****************
   * Drills       *
   ****************/
  const drillSelect = $('#drillSelect'); DRILLS.forEach((s,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=s; drillSelect.appendChild(o) });
  $('#drillSentence').textContent = DRILLS[0];
  drillSelect.addEventListener('change', ()=> $('#drillSentence').textContent = DRILLS[parseInt(drillSelect.value)]);

  $('#playDrill').addEventListener('click', ()=> speak($('#drillSentence').textContent));

  function norm(s){ return s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-zñáéíóúü\s]/gi,'').trim() }

  // Levenshtein distance for similarity scoring
  function lev(a,b){
    a=norm(a); b=norm(b);
    const m=a.length, n=b.length; const dp=Array.from({length:m+1},()=>Array(n+1).fill(0));
    for(let i=0;i<=m;i++) dp[i][0]=i; for(let j=0;j<=n;j++) dp[0][j]=j;
    for(let i=1;i<=m;i++) for(let j=1;j<=n;j++){
      const cost=a[i-1]===b[j-1]?0:1;
      dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
    }
    const dist=dp[m][n]; const max=Math.max(m,n)||1; return 1 - dist/max;
  }

  const recordBtn=$('#recordBtn'); const stopBtn=$('#stopBtn'); const feedback=$('#drillFeedback');
  recordBtn.addEventListener('click', ()=>{
    if(!rec){ alert('Speech recognition not supported.'); return }
    try{
      recording=true; feedback.textContent='Recording…';
      rec.onresult=(e)=>{
        const txt = Array.from(e.results).map(r=>r[0].transcript).join(' ');
        const target = $('#drillSentence').textContent;
        const s = lev(txt, target);
        feedback.innerHTML = `You said: “${txt}”<br>Similarity ≈ <strong>${(s*100).toFixed(0)}%</strong>`;
      };
      rec.start(); recordBtn.disabled=true; stopBtn.disabled=false;
    }catch(err){ alert('Cannot start microphone: '+err.message) }
  });
  stopBtn.addEventListener('click', ()=>{ if(recording){ rec.stop(); recording=false; feedback.textContent='Stopped.'; recordBtn.disabled=false; stopBtn.disabled=true } });

  // Free speak
  $('#startFree').addEventListener('click', ()=>{
    const R = window.SpeechRecognition || window.webkitSpeechRecognition; if(!R){ alert('Speech recognition not supported.'); return }
    freeRec = new R(); freeRec.lang='es-ES'; freeRec.interimResults=true; freeRec.continuous=true; freeOn=true;
    $('#freeTranscript').value=''; $('#stopFree').disabled=false; $('#startFree').disabled=true;
    freeRec.onresult=(e)=>{ const txt=Array.from(e.results).map(r=>r[0].transcript).join(' '); $('#freeTranscript').value=txt };
    freeRec.start();
  });
  $('#stopFree').addEventListener('click', ()=>{ if(freeOn){ freeRec.stop(); freeOn=false; $('#stopFree').disabled=true; $('#startFree').disabled=false } });

  /****************
   * Argument     *
   ****************/
  const argTopic=$('#argTopic'); ARG_TOPICS.forEach(t=>{ const o=document.createElement('option'); o.value=t.id; o.textContent=t.label; argTopic.appendChild(o) });

  function buildParagraph(topicId, reg, points){
    const frames = {
      formal: {
        open: ["Desde una perspectiva académica, sostengo que ", "A nivel teológico, propongo que ", "Con base en el análisis exegético, argumento que "],
        weave: ["en primer lugar, ", "además, ", "no obstante, ", "por consiguiente, "],
        close: ["en definitiva, ", "por lo tanto, ", "en suma, "]
      },
      pastoral: {
        open: ["Con prudencia y claridad, afirmo que ", "A la luz de la Escritura, considero que ", "Con sensibilidad pastoral, sostengo que "],
        weave: ["primero, ", "luego, ", "sin embargo, ", "así pues, "],
        close: ["al final, ", "por ende, ", "en conclusión, "]
      }
    }[reg||'formal'];

    const p = points.filter(x=>x.trim()).map(x=>x.trim());
    const open = frames.open[Math.floor(Math.random()*frames.open.length)];
    const close = frames.close[Math.floor(Math.random()*frames.close.length)];
    const weave = frames.weave;

    let body = p.map((pt,i)=> (weave[Math.min(i, weave.length-1)] + pt.replace(/\.$/,'') + '.')).join(' ');

    const topicLabel = ARG_TOPICS.find(t=>t.id===topicId)?.label || 'el tema propuesto';
    return `${open}${topicLabel.toLowerCase()} merece una defensa rigurosa; ${body} ${close} esta posición resulta más coherente que sus alternativas.`;
  }

  $('#buildArg').addEventListener('click', ()=>{
    const txt = buildParagraph(argTopic.value, $('#argRegister').value, $('#argPoints').value.split(/\n+/));
    $('#argOutput').textContent = txt; $('#speakArg').disabled=false; $('#copyArg').disabled=false;
  });
  $('#speakArg').addEventListener('click', ()=> speak($('#argOutput').textContent));
  $('#copyArg').addEventListener('click', ()=>{ navigator.clipboard.writeText($('#argOutput').textContent); alert('Copied.') });

  /****************
   * Reading Lab  *
   ****************/
  let readingIdx=0;
  function renderReading(){
    const R = READING_PASSAGES[readingIdx % READING_PASSAGES.length];
    const container = $('#readingText');
    // simple glossing: wrap connectors
    const glossed = CONNECTORS.reduce((acc,c)=>{
      const re = new RegExp(`\\b${c.es.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&')}\\b`, 'gi');
      return acc.replace(re, `<span class="tag" title="${c.en}">${c.es}</span>`);
    }, R.text);
    container.innerHTML = spanishOnly.checked ? R.text : glossed;

    const qwrap = $('#readingQs'); qwrap.innerHTML='';
    R.q.forEach((q,i)=>{
      const div=document.createElement('div'); div.className='item';
      div.innerHTML = `<div>${q.p}</div><input type="text" data-q="${i}" placeholder="Respuesta breve">`;
      qwrap.appendChild(div);
    });
    $('#readingScore').textContent='';
  }
  $('#speakReading').addEventListener('click', ()=> speak($('#readingText').textContent));
  $('#nextReading').addEventListener('click', ()=>{ readingIdx++; renderReading() });
  $('#checkReading').addEventListener('click', ()=>{
    const R = READING_PASSAGES[readingIdx % READING_PASSAGES.length];
    const inputs = $$('#readingQs input'); let correct=0;
    inputs.forEach(inp=>{
      const i=parseInt(inp.dataset.q); const ans = R.q[i].a.map(norm);
      if(ans.some(a=> norm(inp.value).includes(a))) correct++;
    });
    $('#readingScore').textContent = `${correct} / ${inputs.length}`;
  });

  /****************
   * Debate       *
   ****************/
  const debatePrompt=$('#debatePrompt'); DEBATE_PROMPTS.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=p.title; debatePrompt.appendChild(o) });

  function buildCue(id, stance){
    const base = DEBATE_PROMPTS.find(p=>p.id===id)?.title || 'el tema asignado';
    const hooks = [
      'defina términos clave antes de argumentar', 'presente una tesis clara en la primera oración',
      'utilice al menos dos conectores académicos', 'incluya una objeción y una respuesta breve'
    ];
    const h = hooks[Math.floor(Math.random()*hooks.length)];
    return `Tarea: adopte la postura ${stance}. Tema: ${base}. Requisitos: ${h}.`;
  }

  $('#startDebate').addEventListener('click', ()=>{
    const cue = buildCue(debatePrompt.value, $('#debateStance').value);
    $('#debateCue').textContent = cue; $('#debateSpeak').disabled=false; $('#debateCopy').disabled=false;
  });
  $('#debateSpeak').addEventListener('click', ()=> speak($('#debateCue').textContent));
  $('#debateCopy').addEventListener('click', ()=>{ navigator.clipboard.writeText($('#debateCue').textContent); alert('Copied.') });

  $('#debateEvaluate').addEventListener('click', ()=>{
    const txt = $('#debateResponse').value;
    const must = ['por consiguiente','no obstante','en definitiva','según','a la luz de'];
    const score = must.reduce((acc,m)=> acc + (txt.toLowerCase().includes(m)?1:0), 0);
    const thesis = /sostengo que|afirmo que|propongo que|defiendo que/.test(txt.toLowerCase())?1:0;
    const len = txt.trim().split(/\s+/).length;
    const lengthScore = len>=80?1:0;
    const total = thesis + score + lengthScore;
    const msg = [`Tesis: ${thesis? '✔':'✖'}`, `Conectores: ${score}/5`, `Longitud: ${lengthScore? '✔':'✖'} (≥80 palabras)`].join(' · ');
    $('#debateFeedback').textContent = `Score ${total}/7 · ${msg}`;
    state.debateCount++; mem.set('debateCount', state.debateCount); renderProgress();
  });

  /****************
   * Quiz         *
   ****************/
  function genCloze(){
    const pool = [...CORE_TERMS]; const pick = pool.sort(()=>Math.random()-0.5).slice(0,5);
    const wrap=$('#clozeWrap'); wrap.innerHTML='';
    pick.forEach((t,i)=>{
      const sent = `Defina el término «${t.es}»:`;
      const div=document.createElement('div'); div.className='item';
      div.innerHTML = `<div>${sent} ${spanishOnly.checked? '' : `<span class="tag" title="${t.en}">hint</span>`}</div>
        <input type="text" data-es="${t.es}" data-en="${t.en}" placeholder="Respuesta en español">`;
      wrap.appendChild(div);
    });
    $('#clozeScore').textContent='';
  }
  function checkCloze(){
    const inputs = $$('#clozeWrap input'); let c=0;
    inputs.forEach(inp=>{ const en=inp.dataset.en.toLowerCase(); const val=inp.value.toLowerCase(); if(val.includes(inp.dataset.es.toLowerCase()) || lev(val, en)>0.65) c++ });
    $('#clozeScore').textContent = `${c} / ${inputs.length}`;
  }
  $('#regenCloze').addEventListener('click', genCloze);
  $('#checkCloze').addEventListener('click', checkCloze);

  function genMC(){
     const wrap=$('#mcWrap'); wrap.innerHTML='';
     MC_BANK.sort(()=>Math.random()-0.5).slice(0,3).forEach((q,i)=>{
       const div=document.createElement('div'); div.className='item';
       div.innerHTML = `<div>${q.q}</div>` + q.options.map((opt,j)=>
         `<label class="row" style="gap:6px"><input type="radio" name="mc${i}" value="${j}"> <span>${opt}</span></label>`
       ).join('');
       div.dataset.answer = String(q.a);
       wrap.appendChild(div);
     });
     $('#mcScore').textContent='';
   }

   function checkMC(){
     const items = $$('#mcWrap .item'); let correct=0;
     items.forEach((div,i)=>{
       const ans = parseInt(div.dataset.answer);
       const chosen = div.querySelector(`input[name="mc${i}"]:checked`);
       if(chosen && parseInt(chosen.value)===ans) correct++;
     });
     $('#mcScore').textContent = `${correct} / ${items.length}`;
   }

   // Events for MC
   $('#regenMC').addEventListener('click', genMC);
   $('#checkMC').addEventListener('click', checkMC);

   // Resources: connectors + exegesis steps
   function renderConnectors(){
     const list = $('#connectorList'); list.innerHTML='';
     CONNECTORS.forEach(c=>{
       const div=document.createElement('div'); div.className='item';
       div.innerHTML = spanishOnly.checked
         ? `<span>${c.es}</span>`
         : `<strong>${c.es}</strong> — <span class="muted">${c.en}</span>`;
       list.appendChild(div);
     });
   }

   function renderExegesis(){
     const ol = $('#exegesisSteps'); ol.innerHTML='';
     EXEGESIS_STEPS.forEach(step=>{
       const li=document.createElement('li'); li.textContent=step; ol.appendChild(li);
     });
   }

   // Master render
   function renderAll(){
     computeDeck();
     renderCustom();
     renderReading();
     genCloze();
     genMC();
     renderConnectors();
     renderExegesis();
     renderProgress();
     rateInfo.textContent = parseFloat(rateRange.value||'1').toFixed(2);
   }

   // Initial render
   renderAll();
   genPlan();
  </script>
 </body>
</html>